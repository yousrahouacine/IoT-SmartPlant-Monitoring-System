{% extends "base.html" %}
{% block content %}

<h1 style="margin-bottom:30px;">ðŸ“Š Analytics</h1>

<!-- ===== KPI CARDS ===== -->
<div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); gap:20px; margin-bottom:30px;">

    <div class="card">
        <h3>ðŸŒ¡ Avg Temperature</h3>
        <p style="font-size:28px;">{{ avg_temp }} Â°C</p>
    </div>

    <div class="card">
        <h3>ðŸŒ± Avg Soil</h3>
        <p style="font-size:28px;">{{ avg_soil }} %</p>
    </div>

    <div class="card">
        <h3>â˜€ Avg Light</h3>
        <p style="font-size:28px;">{{ avg_light }}</p>
    </div>

    <div class="card {{ 'alert' if alert_percentage > 50 else 'ok' }}">
        <h3>âš  Alert Rate</h3>
        <p style="font-size:28px;">{{ alert_percentage }} %</p>
    </div>

</div>

<!-- ===== GRAPH CARD ===== -->
<div class="card">
    <canvas id="sensorChart"></canvas>
</div>

<script>
    const labels = [
        {% for row in history %}
            "{{ row.timestamp }}",
        {% endfor %}
    ];

    const temperatureData = [
        {% for row in history %}
            {{ row.temperature }},
        {% endfor %}
    ];

    const soilData = [
        {% for row in history %}
            {{ row.soil }},
        {% endfor %}
    ];

    const lightData = [
        {% for row in history %}
            {{ row.light }},
        {% endfor %}
    ];

    const ctx = document.getElementById('sensorChart').getContext('2d');

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels.reverse(),
            datasets: [
                {
                    label: 'Temperature (Â°C)',
                    data: temperatureData.reverse(),
                    borderColor: '#e53935',
                    tension: 0.4
                },
                {
                    label: 'Soil Moisture (%)',
                    data: soilData.reverse(),
                    borderColor: '#43a047',
                    tension: 0.4
                },
                {
                    label: 'Light',
                    data: lightData.reverse(),
                    borderColor: '#fdd835',
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            animation: {
                duration: 1500
            },
            plugins: {
                legend: {
                    position: 'top'
                }
            }
        }
    });
</script>

{% endblock %}
